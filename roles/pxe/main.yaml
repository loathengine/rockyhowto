- hosts:
    - services
    
  tasks:
  
  - name: Install tftp service
    dnf:
      name:
        - tftp-server
        - syslinux
        - syslinux-tftpboot
        - policycoreutils-python-utils 
      state: latest

  - name: Create new dirs
    ansible.builtin.file:
      path: "{{ item }}"
      state: directory
    loop:
      - /home/iso/mnt
      - /home/tftpboot
      - /home/tftpboot/rocky9pxe
      - /home/tftpboot/rocky9iso
      - /home/tftpboot/rocky9ks
      - /home/tftpboot/pxelinux.cfg
      
  - name: Update SElinux to allow tftp service to use the new dir
    command: 
    - semanage fcontext -a -t tftpdir_rw_t "/home/tftpboot(/.*)?"
    - restorecon -R -v /home/tftpboot

  - name: Edit the service to use the new dir
    lineinfile: 
      path: /lib/systemd/system/tftp.service 
      regexp: '^(.*)ExecStart(.*)$' 
      line: 'ExecStart=/usr/sbin/in.tftpd -s /home/tftpboot'
      backrefs: yes

  - name: Restart service tftp also issue daemon-reload to pick up config changes
    ansible.builtin.systemd_service:
      state: restarted
      daemon_reload: true
      name: tftp

- name: Extract kernel and ramdisk from a LiveCD
  community.general.iso_extract:
    image: /home/iso/Rocky9.iso
    dest: /home/tftpboot/rocky9pxe
    files:
    - images/pxeboot/initrd.img
    - images/pxeboot/initrd.img

  - name: copy contents to iso directorys
    shell: |
      mount -o loop /home/iso/Rocky9.iso /home/iso/mnt
      cp -rpv /home/iso/mnt/* /home/tftpboot/rocky9iso
      cp -rpv /usr/share/syslinux/* /home/tftpboot


  - name: Write a block of text to the file
    blockinfile:
      path: /home/tftpboot/rocky9ks
      create: true
      marker: ""
      block: |
        # Generated by Anaconda 34.25.3.8
        # Generated by pykickstart v3.32
        #version=RHEL9
        text
        reboot
        repo --name="baseos" --baseurl=http://10.9.8.10/repo/baseos/ --install
        repo --name="epel" --baseurl=http://10.9.8.10/repo/epel/ --install
        keyboard --vckeymap=us --xlayouts='us'
        lang en_US.UTF-8
        firewall --enabled --service=ssh
        network  --bootproto=dhcp --device=link --noipv6 --activate
        url --url="http://10.9.8.10/repo/baseos/"
        %packages
        @^minimal-environment
        %end
        selinux --enforcing
        firstboot --disable
        skipx
        bootloader --append="rhgb quiet crashkernel=1G-4G:192M,4G-64G:256M,64G-:512M" --location=mbr --boot-drive=sda
        autopart
        zerombr
        clearpart --all --initlabel
        timezone Etc/UTC --utc
        rootpw --lock
        user --groups=wheel --name=breakglass --password=$6$FVwlA/hG5VmFeGaR$VcIZkgMWKxRYmawyDFOmgZuQ9Fzy0uh.Q.y3N6xUvURQ0bbXzeDy0n3mrX.idi1Wj1abppIfSmeloO5fn2SFC/ --iscrypted

  - name: Write a block of text to the file
    blockinfile:
      path: /home/tftpboot/pxelinux.cfg/default
      create: true
      marker: ""
      block: |
        default menu.c32
        prompt 0
        timeout 50
        ONTIMEOUT 1
        
        menu title ########## Lab PXE Boot Menu ##########
        label 1
           menu label ^1) Boot from local drive
           localboot
        label 2
           menu label ^2) Install Rocky 9 from inst.stage2
           kernel rocky9pxe/vmlinuz
           append initrd=rocky9pxe/initrd.img noapic inst.stage2=http://10.9.8.10/tftpboot/rocky9iso/ ip=dhcp
        label 3
           menu label ^3) Install Rocky 9 from inst.stage2 and kickstart
           kernel rocky9pxe/vmlinuz
           append initrd=rocky9pxe/initrd.img noapic inst.stage2=http://10.9.8.10/tftpboot/rocky9iso/ ip=dhcp inst.ks=http://10.9.8.10/tftpboot/rocky9ks/rocky9ks
        label 4
           menu label ^4) Install Openshift Bootstrap
           KERNEL openshift/rhcos-live-kernel-x86_64
           APPEND initrd=openshift/rhcos-live-initramfs.x86_64.img coreos.live.rootfs_url=http://10.9.8.10/tftpboot/openshift/rhcos-live-rootfs.x86_64.img coreos.inst.install_dev=/dev/sda coreos.inst.ignition_url=http://10.9.8.10/tftpboot/openshift/bootstrap.ign
        label 5
           menu label ^5) Install Openshift Control-Plane
           KERNEL openshift/rhcos-live-kernel-x86_64
           APPEND initrd=openshift/rhcos-live-initramfs.x86_64.img coreos.live.rootfs_url=http://10.9.8.10/tftpboot/openshift/rhcos-live-rootfs.x86_64.img coreos.inst.install_dev=/dev/sda coreos.inst.ignition_url=http://10.9.8.10/tftpboot/openshift/master.ign
